<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>LHM Dashboard</title>
        <script src="Chart.bundle.min.js"></script>
        <style type="text/css">
            div.box {
                margin:0;
                float:left;
                clear:none;
                width:50%;
                height:50%;
                background:#050508;
            }

            div.canvas {
                background:#101520;
                width:100%;
                height:100%;
            }

            html,body {
                height:100%;
                margin:0;
                padding:0;
            }

			div.container {
                width: 100%;
                height: 100%;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            /* CSS for mobile view  */
            @media (max-width:1024px) {
                div.container {
                    justify-content: space-around;
                }
                
                div.box {
                    width: 100%;
                }
            }
        </style>        
    </head>
    <body>
		<div class="container">
        	<div class="box">
        	    <div class="canvas"><canvas id="TempChart"></canvas></div>
        	</div>
        	<div class="box">
        	    <div class="canvas"><canvas id="PowerChart"></canvas></div>
        	</div>
        	<div class="box">
        	    <div class="canvas"><canvas id="ClockChart"></canvas></div>
        	</div>
        	<div class="box">
        	    <div class="canvas"><canvas id="LoadChart"></canvas></div>
			</div>
		</div>
        <script>
            //Define colors
            const colorCPULine = 'rgba(255, 0, 0, 1)';
            const colorCPUFill = 'rgba(255, 0, 0, 0.025)';
            const colorCPULine1 = 'rgba(255, 0, 255, 1)';
            const colorCPUFill1 = 'rgba(255, 0, 255, 0.025)';
            const colorGPULine = 'rgba(80, 255, 160, 1)';
            const colorGPUFill = 'rgba(80, 255, 160, 0.025)';
            const colorGPULine1 = 'rgba(255, 255, 160, 1)';
            const colorGPUFill1 = 'rgba(255, 255, 160, 0.025)';
            const colorGPULine2 = 'rgba(80, 224, 255, 1)';
            const colorGPUFill2 = 'rgba(80, 224, 255, 0.025)';
            const colorVRMLine = 'rgba(0, 80, 255, 1)';
            const colorVRMFill = 'rgba(0, 80, 255, 0.025)';
            const colorPCHLine = 'rgba(255, 255, 0, 1)';
            const colorPCHFill = 'rgba(255, 255, 0, 0.025)';
            const colorCPUSocketLine = 'rgba(255, 0, 255, 1)';
            const colorCPUSocketFill = 'rgba(255, 0, 255, 0.025)';
            const colorFan0Line = 'rgba(255, 255, 255, 1)';
            const colorFan0Fill = 'rgba(255, 255, 255, 0.025)';

            const colorGridLine0 = '#506080';
            const colorGridLine1 = '#806050';

            //Borders
            const widthBorders=2;
            const gridLineWidthX=1;
            const gridLineWidthY=1;

            //Fonts
            Chart.defaults.global.defaultFontFamily = "'DejaVu Sans Mono', Monospace";
            Chart.defaults.global.defaultFontSize = 24;
            Chart.defaults.global.defaultFontColor = "#fff";
            const fontSizeLegendY=20;
            const fontSizeLegendX=20;

            //Config
            var chartTimeFrame = 150;
            var boolPrefillChart = true;

            //Globals
            var sensorIndex=0;

            var TempChart = new Chart(document.getElementById('TempChart').getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'CPU Temperature',
                            data: [],
                            backgroundColor: [colorCPUFill],
                            borderColor: [colorCPULine],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'GPU Temperature',
                            data: [],
                            backgroundColor: [colorGPUFill],
                            borderColor: [colorGPULine],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'VRM Temperature',
                            data: [],
                            backgroundColor: [colorVRMFill],
                            borderColor: [colorVRMLine],
                            borderWidth: widthBorders
                        }
                        ,
                        {
                            label: 'PCH Temperature',
                            data: [],
                            backgroundColor: [colorPCHFill],
                            borderColor: [colorPCHLine],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'Rad',
                            data: [],
                            backgroundColor: [colorFan0Fill],
                            borderColor: [colorFan0Line],
                            borderWidth: widthBorders,
                            yAxisID: 'rpm'
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    title: {
                        display: true,
                        text: 'Temperatures (Â°C) & Fans (RPM)'
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                stepSize: 5,
                                fontSize: fontSizeLegendY
                            },
                            gridLines: {
                                color: colorGridLine0,
                                lineWidth: gridLineWidthY
                            }
                        },
                        {
                            id: 'rpm',
                            ticks: {
                                stepSize: 100,
                                fontSize: fontSizeLegendY
                            },
                            gridLines: {
                                color: colorGridLine1,
                                lineWidth: gridLineWidthY
                            }
                        }],
                        xAxes: [{
                           type: 'time',
                           ticks: {
                               fontSize: fontSizeLegendX
                           },
                           time: {
                               unit: 'second',
                               stepSize: 10,
                               displayFormats: {
                                   second: 'HH:mm:ss'
                               }
                           },
                           gridLines: {
                               color: colorGridLine0,
                               lineWidth: gridLineWidthX
                           }
                        }]
                    },
                    animation: false,
                    tooltips: {
                        enabled: false
                    },
                    elements: {
                        line: {
                            tension: 0
                        },
                        point: {
                            radius: 0,
                            borderColor: 'transparent',
                            backgroundColor: 'transparent'
                        }
                    },
                    layout: {
                        padding: {
                            left: 0,
                            right: 10,
                            top: 0,
                            bottom: 0
                        }
                    }
                }
            });

            var PowerChart = new Chart(document.getElementById('PowerChart').getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'CPU:',
                            data: [],
                            backgroundColor: [colorCPUFill],
                            borderColor: [colorCPULine],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'GPU:',
                            data: [],
                            backgroundColor: [colorGPUFill],
                            borderColor: [colorGPULine],
                            borderWidth: widthBorders
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    title: {
                        display: true,
                        text: 'Power Monitor (W)'
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                stepSize: 50,
                                fontSize: fontSizeLegendY
                            },
                            gridLines: {
                                color: colorGridLine0,
                                lineWidth: gridLineWidthY
                            }
                        }],
                        xAxes: [{
                            type: 'time',
                            ticks: {
                                fontSize: fontSizeLegendX
                            },
                            time: {
                                unit: 'second',
                                stepSize: 10,
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            gridLines: {
                                color: colorGridLine0,
                                lineWidth: gridLineWidthX
                            }
                        }]
                    },
                    animation: false,
                    tooltips: {
                        enabled: false
                    },
                    elements: {
                        line: {
                            tension: 0
                        },
                        point: {
                            radius: 0,
                            borderColor: 'transparent',
                            backgroundColor: 'transparent'
                        }
                    },
                    layout: {
                        padding: {
                            left: 0,
                            right: 10,
                            top: 0,
                            bottom: 0
                        }
                    }
                }
            });

            var ClockChart = new Chart(document.getElementById('ClockChart').getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'CPU Max:',
                            data: [],
                            backgroundColor: [colorCPUFill],
                            borderColor: [colorCPULine],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'CPU Avg:',
                            data: [],
                            backgroundColor: [colorCPUFill1],
                            borderColor: [colorCPULine1],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'GPU Core:',
                            data: [],
                            backgroundColor: [colorGPUFill],
                            borderColor: [colorGPULine],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'GPU Memory:',
                            data: [],
                            backgroundColor: [colorGPUFill1],
                            borderColor: [colorGPULine1],
                            borderWidth: widthBorders
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    title: {
                        display: true,
                        text: 'Clocks (MHz)'
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                stepSize: 500,
                                fontSize: fontSizeLegendY
                            },
                            gridLines: {
                                color: colorGridLine0,
                                lineWidth: gridLineWidthY
                            }
                        }],
                        xAxes: [{
                            type: 'time',
                            ticks: {
                                fontSize: fontSizeLegendX
                            },
                            time: {
                                unit: 'second',
                                stepSize: 10,
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            gridLines: {
                                color: colorGridLine0,
                                lineWidth: gridLineWidthX
                            }
                        }]
                    },
                    animation: false,
                    tooltips: {
                        enabled: false
                    },
                    elements: {
                        line: {
                            tension: 0
                        },
                        point: {
                            radius: 0,
                            borderColor: 'transparent',
                            backgroundColor: 'transparent'
                        }
                    },
                    layout: {
                        padding: {
                            left: 0,
                            right: 10,
                            top: 0,
                            bottom: 0
                        }
                    }
                }
            });

            var LoadChart = new Chart(document.getElementById('LoadChart').getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'CPU',
                            data: [],
                            backgroundColor: [colorCPUFill],
                            borderColor: [colorCPULine],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'GPU C',
                            data: [],
                            backgroundColor: [colorGPUFill],
                            borderColor: [colorGPULine],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'GPU MC',
                            data: [],
                            backgroundColor: [colorGPUFill1],
                            borderColor: [colorGPULine1],
                            borderWidth: widthBorders
                        },
                        {
                            label: 'GPU VE',
                            data: [],
                            backgroundColor: [colorGPUFill2],
                            borderColor: [colorGPULine2],
                            borderWidth: widthBorders
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    title: {
                        display: true,
                        text: 'Load (%)'
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                stepSize: 10,
                                fontSize: fontSizeLegendY
                            },
                            gridLines: {
                                color: colorGridLine0,
                                lineWidth: gridLineWidthY
                            }
                        }],
                        xAxes: [{
                           type: 'time',
                           ticks: {
                               fontSize: fontSizeLegendX
                           },
                           time: {
                               unit: 'second',
                               stepSize: 10,
                               displayFormats: {
                                   second: 'HH:mm:ss'
                               }
                           },
                           gridLines: {
                               color: colorGridLine0,
                               lineWidth: gridLineWidthY
                           }
                        }]
                    },
                    animation: false,
                    tooltips: {
                        enabled: false
                    },
                    elements: {
                        line: {
                            tension: 0
                        },
                        point: {
                            radius: 0,
                            borderColor: 'transparent',
                            backgroundColor: 'transparent'
                        }
                    },
                    layout: {
                        padding: {
                            left: 0,
                            right: 10,
                            top: 0,
                            bottom: 0
                        }
                    }
                }
            });

            //Helper functions
            function round(value, precision) {
                var multiplier = Math.pow(10, precision || 0);
                return Math.round(value * multiplier) / multiplier;
            }

            function cleanReading(reading) {
                return parseFloat(reading.replace(',', '.').replace(/[^0-9.]/g, ""));
            }

            function prefillChart(chartData) {
                chartData.length=0;
                var currDateTime=new Date()
                currDateTime.setTime(currDateTime.getTime()-chartTimeFrame*1000);
                for(var i=0;i<chartTimeFrame;i++) chartData.push({x:new Date(currDateTime.getTime()+i*1000),y:undefined})
            }

            function prefillAllDatasets(chart) {
                for(var i=0;i<chart.data.datasets.length;i++)
                    prefillChart(chart.data.datasets[i].data);
            }

            function cleanupGraph(chartData) {
                if(chartData.length!=0) {
                    if(chartData.length>=chartTimeFrame) chartData.splice(0,1);
                    if(new Date().getTime()-chartData[chartData.length-1].x.getTime()>5000) {
                        if(boolPrefillChart) {
                            prefillChart(chartData);
                        } else {
                            chartData.length=0;
                        }
                    }
                }
            }

            function plotNextSensor(chart, label, value, special = "") {
                switch(special) {
                    case "cpu cores":
                        //Determine max and average core clocks
                        var max=0,total=0,avg=0,cores=0;
                        var cores = value.Children[1].Children[1].Children;
                        var numCores = cores.length;
                        for(c=0;c<numCores;c++) {
                            var clean=cleanReading(cores[c].Value);
                            if(max<clean) max=clean;
                            total+=clean;
                        }
                        avg = total/numCores;

                        //Plot it.
                        cleanupGraph(chart.data.datasets[sensorIndex].data);
                        chart.data.datasets[sensorIndex].data.push({x:new Date(),y:max});
                        chart.data.datasets[sensorIndex].label = label+" Max: "+round(max,1).toFixed(1);
                        sensorIndex++;

                        cleanupGraph(chart.data.datasets[sensorIndex].data);
                        chart.data.datasets[sensorIndex].data.push({x:new Date(),y:avg});
                        chart.data.datasets[sensorIndex].label = label+" Avg: "+round(avg,1).toFixed(1);
                        sensorIndex++;
                        break;
                    default:
                        var clean = cleanReading(value);
                        if(special=="div2") clean/=2; //Divides through 2 if requested. Useful to convert DDR Memory GT/s back to MHz.
                        cleanupGraph(chart.data.datasets[sensorIndex].data);
                        chart.data.datasets[sensorIndex].data.push({x:new Date(),y:clean});
                        chart.data.datasets[sensorIndex].label = label+round(clean,1).toFixed(1);
                        sensorIndex++;
                        break;
                }
            }

            //XHR callback
            function refreshSensors() {
                var x = new XMLHttpRequest();
                x.open("GET", "data.json");
                x.addEventListener("load", function(e) {
                    var data = JSON.parse(x.response).Children[0];
                    
                    //Temperatures and Fans ------------
                    //Ryzen TR CPU temp
                    plotNextSensor(TempChart, "CPU: ", data.Children[1].Children[2].Children[1].Value);
                    //NVIDIA GPU Temp
                    plotNextSensor(TempChart, "GPU: ", data.Children[3].Children[1].Children[0].Value);
                    //ASUS VRM Temp
                    plotNextSensor(TempChart, "VRM: ", data.Children[0].Children[0].Children[1].Children[5].Value);
                    //ASUS PCH Temp
                    plotNextSensor(TempChart, "PCH: ", data.Children[0].Children[0].Children[1].Children[3].Value);
                    //ASUS Fan 0
                    plotNextSensor(TempChart, "Rad: ", data.Children[0].Children[0].Children[2].Children[0].Value);

                    //Power Monitor ------------
                    sensorIndex=0;
                    //Ryzen TR CPU package power
                    plotNextSensor(PowerChart, "CPU: ", data.Children[1].Children[5].Children[0].Value);
                    //NVIDIA GPU power
                    plotNextSensor(PowerChart, "GPU: ", data.Children[3].Children[3].Children[0].Value);

                    //Clocks ------------
                    sensorIndex=0;
                    //CPU Clocks
                    plotNextSensor(ClockChart, "CPU", data, "cpu cores");
                    //GPU Clocks
                    plotNextSensor(ClockChart, "GPU Core: ", data.Children[3].Children[0].Children[0].Value);
                    plotNextSensor(ClockChart, "GPU Memory: ", data.Children[3].Children[0].Children[1].Value, "div2");

                    //Loads ------------
                    sensorIndex=0;
                    //CPU Total
                    plotNextSensor(LoadChart, "CPU: ", data.Children[1].Children[3].Children[0].Value);
                    //NVIDIA GPU Core
                    plotNextSensor(LoadChart, "GPU: ", data.Children[3].Children[2].Children[0].Value);
                    //NVIDIA Memory Controller
                    plotNextSensor(LoadChart, "GPU MC: ", data.Children[3].Children[2].Children[1].Value);
                    //NVIDIA Video Engine
                    plotNextSensor(LoadChart, "GPU VE: ", data.Children[3].Children[2].Children[2].Value);

                    sensorIndex=0;
                    TempChart.update();
                    PowerChart.update();
                    ClockChart.update();
                    LoadChart.update();
                });
                x.send();
                setTimeout(refreshSensors, 1000);
            }
    
            //Init
            if(boolPrefillChart) {
                prefillAllDatasets(TempChart);
                prefillAllDatasets(PowerChart);
                prefillAllDatasets(ClockChart);
                prefillAllDatasets(LoadChart);
            }
            refreshSensors();
        </script>
    </body>
</html>